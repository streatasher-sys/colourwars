<!DOCTYPE html>
<html>
<head>
  <title>Colour Wars — Online 4 Player</title>
  <style>
    body { display: flex; flex-direction: column; align-items: center; margin-top: 30px; font-family: sans-serif; }
    #lobby { text-align: center; }
    #lobby button, #lobby input { font-size: 16px; padding: 10px 16px; margin: 8px; }
    #gameArea { display: none; }
    canvas { border: 2px solid black; display: block; }
    #turnIndicator { margin-bottom: 10px; font-size: 18px; font-weight: bold; min-height: 1.5em; }
    #roomCode { margin-bottom: 8px; font-size: 14px; color: #282; }
    #roomCode span { font-weight: bold; letter-spacing: 2px; }
    #playerInfo { margin-bottom: 6px; font-size: 14px; }
    #playerCount { margin-bottom: 6px; font-size: 14px; color: #282; }
    #timerBar { margin-bottom: 8px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    #timerBar .timer { font-size: 14px; font-weight: bold; }
    #endScreen {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center;
      z-index: 200; flex-direction: column; gap: 16px; padding: 24px;
    }
    #endScreen.visible { display: flex; }
    #endScreen .endBox {
      background: white; border-radius: 12px; padding: 24px; max-width: 360px; width: 100%;
      text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #endScreen .winnerText { font-size: 22px; font-weight: bold; margin-bottom: 16px; }
    #endScreen .ratingTable { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
    #endScreen .ratingTable th, #endScreen .ratingTable td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
    #endScreen .ratingTable th { font-weight: 600; color: #333; }
    #endScreen .deltaPos { color: #282; font-weight: 600; }
    #endScreen .deltaNeg { color: #c22; font-weight: 600; }
    #endScreen .backBtn { font-size: 16px; padding: 12px 24px; background: #282; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 12px; }
    #endScreen .backBtn:hover { background: #1a6b1a; }
  </style>
</head>
<body>
<div id="lobby">
  <h1>Colour Wars — Online 4 Player</h1>
  <p>Find a game or create one and share the room code. Up to 4 players (Red, Green, Blue, Yellow).</p>
  <button id="findMatchBtn">Find Game</button>
  <div id="matchmakingStatus" style="display: none; margin-top: 10px;">
    <span id="matchmakingText">Searching for players...</span>
    <button id="cancelMatchBtn" style="margin-left: 12px;">Cancel</button>
  </div>
  <p style="margin-top: 16px; font-size: 14px; color: #282;">— or —</p>
  <button id="createBtn">Create Private Game</button>
  <div style="margin-top: 16px;">
    <input type="text" id="joinInput" placeholder="Room code" maxlength="6" style="text-transform: uppercase;">
    <button id="joinBtn">Join Game</button>
  </div>
  <p id="connectionStatus" style="margin-top: 12px; font-size: 14px; min-height: 1.2em;"></p>
  <p id="lobbyMsg" style="margin-top: 8px; color: #c00; min-height: 1.2em;"></p>
</div>

<div id="gameArea">
  <div id="roomCode">Room: <span id="roomCodeVal"></span></div>
  <div id="playerInfo">You control: <span id="myColour"></span></div>
  <div id="playerCount"></div>
  <div id="turnIndicator">Red's turn</div>
  <div id="timerBar">
    <span class="timer" id="redTimer" style="color: #c22;">5:00</span>
    <span class="timer" id="greenTimer" style="color: #282;">5:00</span>
    <span class="timer" id="blueTimer" style="color: #26a;">5:00</span>
    <span class="timer" id="yellowTimer" style="color: #da4;">5:00</span>
  </div>
  <canvas id="boardCanvas" width="350" height="350"></canvas>
  <div id="endScreen">
    <div class="endBox">
      <div class="winnerText" id="endWinnerText">Red wins!</div>
      <div id="endRatingArea">
        <div id="endRatingLoading" style="color:#666; margin:12px 0;">Loading rating changes...</div>
        <table class="ratingTable" id="endRatingTable" style="display:none;">
          <thead><tr><th>Player</th><th>Rating</th><th>Change</th></tr></thead>
          <tbody id="endRatingBody"></tbody>
        </table>
        <div id="endRatingNone" style="display:none; color:#666; margin:12px 0;">No rating changes (guest game)</div>
      </div>
      <button class="backBtn" id="endBackBtn">Back to Main</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
if (typeof io === "undefined") {
  document.getElementById("lobbyMsg").textContent = "Cannot connect. Open this page via http://localhost:3000 (start the server with: npm start)";
  document.getElementById("createBtn").disabled = true;
  document.getElementById("joinBtn").disabled = true;
  document.getElementById("findMatchBtn").disabled = true;
} else {
  const socket = io();
  const statusEl = document.getElementById("connectionStatus");
  statusEl.textContent = "Connecting...";
  function emitAuth() {
    const token = localStorage.getItem("colourwars_token");
    if (token) socket.emit("auth", token);
  }
  socket.on("connect", () => {
    statusEl.textContent = "Connected";
    statusEl.style.color = "#282";
    emitAuth();
  });
  socket.on("connect_error", () => {
    statusEl.textContent = "Disconnected. Is the server running? (npm start)";
    statusEl.style.color = "#c00";
  });
  socket.on("disconnect", () => {
    statusEl.textContent = "Disconnected";
    statusEl.style.color = "#c00";
  });

  const rows = 7;
  const cols = 7;
  const cellSize = 50;
  const red = 1;
  const green = -1;
  const blue = 3;
  const yellow = 4;
  const PLAYERS = [red, green, blue, yellow];
  const PLAYER_NAMES = { [red]: "Red", [green]: "Green", [blue]: "Blue", [yellow]: "Yellow" };
  const PLAYER_COLORS = { [red]: "#c22", [green]: "#282", [blue]: "#26a", [yellow]: "#da4" };

  let board = null;
  let myPlayer = null;
  let roomCode = null;
  let currentPlayerIndex = 0;
  let winner = 0;
  let gameEnded = false;
  let playerCount = 0;
  let playerTimeRemaining = null;
  let playerIsAI = null;
  let playerNames = {};
  let turnStartTime = 0;
  let playersReady = false;
  let timerInterval = null;
  const canvas = document.getElementById("boardCanvas");
  const ctx = canvas.getContext("2d");

  function showLobby(msg) {
    document.getElementById("lobby").style.display = "block";
    document.getElementById("gameArea").style.display = "none";
    document.getElementById("lobbyMsg").textContent = msg || "";
    document.getElementById("joinBtn").disabled = false;
    document.getElementById("findMatchBtn").disabled = false;
    document.getElementById("matchmakingStatus").style.display = "none";
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  }

  function showGame() {
    document.getElementById("lobby").style.display = "none";
    document.getElementById("gameArea").style.display = "block";
    document.getElementById("matchmakingStatus").style.display = "none";
    document.getElementById("roomCodeVal").textContent = roomCode;
    const endEl = document.getElementById("endScreen");
    if (endEl) endEl.classList.remove("visible");
    updatePlayerCount();
    updatePlayerInfo();
  }

  function updatePlayerCount() {
    const el = document.getElementById("playerCount");
    if (playerCount > 0) el.textContent = "Players: " + playerCount + "/4";
    else el.textContent = "";
  }

  function isUnstable(board, row, col) {
    return board[row][col].count >= 4;
  }

  function drawBoard() {
    if (!board) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let r = 0; r < rows; r++) {
      for (let c = 0; c < cols; c++) {
        ctx.strokeStyle = "black";
        ctx.strokeRect(c * cellSize, r * cellSize, cellSize, cellSize);
        const cell = board[r][c];
        if (cell.count > 0) {
          ctx.fillStyle = PLAYER_COLORS[cell.owner] || "#282";
          const radius = 10 + 5 * (cell.count - 1);
          ctx.beginPath();
          ctx.arc(c * cellSize + cellSize / 2, r * cellSize + cellSize / 2, radius, 0, 2 * Math.PI);
          ctx.fill();
          ctx.fillStyle = cell.owner === yellow ? "#333" : "white";
          ctx.font = "bold 16px Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText(cell.count, c * cellSize + cellSize / 2, r * cellSize + cellSize / 2);
        }
        if (isUnstable(board, r, c)) {
          ctx.strokeStyle = "orange";
          ctx.lineWidth = 3;
          ctx.strokeRect(c * cellSize + 1, r * cellSize + 1, cellSize - 2, cellSize - 2);
          ctx.lineWidth = 1;
        }
      }
    }
  }

  function updatePlayerInfo() {
    const el = document.getElementById("myColour");
    if (el && myPlayer) {
      el.textContent = PLAYER_NAMES[myPlayer];
      el.style.color = PLAYER_COLORS[myPlayer] || "#282";
    }
  }

  function showEndScreen(winningPlayer, results) {
    const el = document.getElementById("endScreen");
    const winnerEl = document.getElementById("endWinnerText");
    const loadingEl = document.getElementById("endRatingLoading");
    const tableEl = document.getElementById("endRatingTable");
    const bodyEl = document.getElementById("endRatingBody");
    const noneEl = document.getElementById("endRatingNone");
    if (!el) return;
    winnerEl.textContent = PLAYER_NAMES[winningPlayer] + " wins!";
    winnerEl.style.color = PLAYER_COLORS[winningPlayer] || "#282";
    if (results === null) {
      loadingEl.style.display = "block";
      tableEl.style.display = "none";
      noneEl.style.display = "none";
    } else if (results.length === 0) {
      loadingEl.style.display = "none";
      tableEl.style.display = "none";
      noneEl.style.display = "block";
    } else {
      loadingEl.style.display = "none";
      noneEl.style.display = "none";
      tableEl.style.display = "table";
      bodyEl.innerHTML = results.map((r) => {
        const deltaStr = r.delta >= 0 ? "+" + r.delta : String(r.delta);
        const deltaClass = r.delta >= 0 ? "deltaPos" : "deltaNeg";
        return `<tr><td><span style="color:${PLAYER_COLORS[r.playerId]}">${PLAYER_NAMES[r.playerId]}</span> — ${r.username}</td><td>${r.oldRating} → ${r.newRating}</td><td class="${deltaClass}">${deltaStr}</td></tr>`;
      }).join("");
    }
    el.classList.add("visible");
  }

  function updateTurnIndicator() {
    const turnEl = document.getElementById("turnIndicator");
    if (winner !== 0) {
      turnEl.textContent = PLAYER_NAMES[winner] + " wins!";
      turnEl.style.color = PLAYER_COLORS[winner];
      return;
    }
    if (!playersReady) {
      turnEl.textContent = "Waiting for all players to join...";
      turnEl.style.color = "#666";
      return;
    }
    const current = PLAYERS[currentPlayerIndex];
    const isMyTurn = current === myPlayer;
    const cpIsAI = (playerIsAI && playerIsAI[current]) || false;
    const cpLabel = playerNames[current] && playerNames[current] !== "—"
      ? PLAYER_NAMES[current] + " (" + playerNames[current] + ")"
      : PLAYER_NAMES[current];
    if (isMyTurn) {
      turnEl.textContent = "Your turn (" + cpLabel + ")";
    } else {
      turnEl.textContent = (cpIsAI ? "AI" : (playerNames[current] || "Opponent")) + "'s turn (" + cpLabel + ")";
    }
    turnEl.style.color = PLAYER_COLORS[current] || "";
  }

  function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = Math.floor(sec % 60);
    return m + ":" + (s < 10 ? "0" : "") + s;
  }

  function updateTimerDisplay() {
    if (!board || gameEnded) return;
    const ids = ["redTimer", "greenTimer", "blueTimer", "yellowTimer"];
    const pids = [red, green, blue, yellow];
    const shouldCountDown = playersReady && playerTimeRemaining && turnStartTime;
    for (let i = 0; i < 4; i++) {
      let display = (playerTimeRemaining && playerTimeRemaining[pids[i]]) ?? 300;
      if (shouldCountDown) {
        const now = Date.now() / 1000;
        const elapsed = now - (turnStartTime / 1000);
        const cp = PLAYERS[currentPlayerIndex];
        if (cp === pids[i] && (!playerIsAI || !playerIsAI[cp])) {
          display = Math.max(0, display - elapsed);
        }
      }
      const el = document.getElementById(ids[i]);
      const label = playerNames[pids[i]] && playerNames[pids[i]] !== "—"
        ? PLAYER_NAMES[pids[i]] + " — " + playerNames[pids[i]]
        : PLAYER_NAMES[pids[i]];
      if (el) el.textContent = label + ": " + formatTime(display);
    }
  }

  canvas.addEventListener("click", (e) => {
    if (!board || gameEnded || winner !== 0) return;
    if (!playersReady) return;
    if (PLAYERS[currentPlayerIndex] !== myPlayer) return;

    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    const row = Math.floor(y / cellSize);
    const col = Math.floor(x / cellSize);

    socket.emit("move", { code: roomCode, row, col });
  });

  socket.on("roomCreated", (data) => {
    roomCode = data.code;
    myPlayer = data.player;
    playerCount = 1;
    showGame();
  });

  socket.on("joinedRoom", (data) => {
    roomCode = data.code;
    myPlayer = data.player;
    showGame();
  });

  socket.on("matched", (data) => {
    roomCode = data.code;
    myPlayer = data.player;
    playerCount = 4;
    showGame();
  });

  socket.on("matchmakingStatus", (data) => {
    if (data.mode !== "4player") return;
    if (data.searching) {
      document.getElementById("findMatchBtn").disabled = true;
      document.getElementById("matchmakingStatus").style.display = "block";
      document.getElementById("matchmakingText").textContent = "Searching for players... (" + (data.position || "?") + "/4)";
      document.getElementById("lobbyMsg").textContent = "";
    } else {
      document.getElementById("findMatchBtn").disabled = false;
      document.getElementById("matchmakingStatus").style.display = "none";
      document.getElementById("lobbyMsg").textContent = "";
    }
  });

  socket.on("joinError", (msg) => {
    document.getElementById("joinBtn").disabled = false;
    document.getElementById("lobbyMsg").textContent = msg;
  });

  socket.on("gameState", (state) => {
    board = state.board;
    currentPlayerIndex = state.currentPlayerIndex ?? 0;
    winner = state.winner || 0;
    gameEnded = winner !== 0;
    playerTimeRemaining = state.playerTimeRemaining || null;
    playerIsAI = state.playerIsAI || null;
    playerNames = state.playerNames || {};
    turnStartTime = state.turnStartTime ?? Date.now();
    playersReady = state.playersReady || false;
    drawBoard();
    updatePlayerInfo();
    updateTurnIndicator();
    updateTimerDisplay();
    if (!timerInterval && !gameEnded) {
      timerInterval = setInterval(updateTimerDisplay, 200);
    }
    if (gameEnded) {
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      showEndScreen(winner, null);
    }
  });

  socket.on("ratingResults", (data) => {
    if (data && data.winner) showEndScreen(data.winner, data.results || []);
  });

  document.getElementById("endBackBtn").addEventListener("click", () => {
    window.location.href = "/";
  });

  socket.on("playerTimedOut", (data) => {
    const p = data.player;
    if (!playerIsAI) playerIsAI = {};
    playerIsAI[p] = true;
    if (p === myPlayer) {
      alert("You ran out of time! AI is now playing for you.");
    } else {
      alert(PLAYER_NAMES[p] + " ran out of time. AI has taken over.");
    }
  });

  socket.on("playerJoined", (data) => {
    playerCount = (data && data.count) ? data.count : (playerCount + 1);
    if (playerCount > 4) playerCount = 4;
    updatePlayerCount();
    document.getElementById("roomCodeVal").textContent = roomCode + " (" + playerCount + "/4)";
  });

  socket.on("playerLeft", (data) => {
    const name = data && data.player ? PLAYER_NAMES[data.player] : "A player";
    alert(name + " left the game.");
    roomCode = null;
    board = null;
    showLobby("Someone disconnected. Create or join a new game.");
  });

  document.getElementById("findMatchBtn").addEventListener("click", () => {
    document.getElementById("lobbyMsg").textContent = "";
    emitAuth();
    socket.emit("findMatch4");
  });

  document.getElementById("cancelMatchBtn").addEventListener("click", () => {
    socket.emit("cancelMatchmaking4");
  });

  document.getElementById("createBtn").addEventListener("click", () => {
    emitAuth();
    socket.emit("createRoom4");
  });

  document.getElementById("joinBtn").addEventListener("click", () => {
    const code = document.getElementById("joinInput").value.trim();
    if (!code) {
      document.getElementById("lobbyMsg").textContent = "Enter a room code";
      return;
    }
    document.getElementById("joinBtn").disabled = true;
    document.getElementById("lobbyMsg").textContent = "Joining...";
    emitAuth();
    socket.emit("joinRoom4", code);
  });

  document.getElementById("joinInput").addEventListener("keypress", (e) => {
    if (e.key === "Enter") document.getElementById("joinBtn").click();
  });
}
</script>
</body>
</html>
