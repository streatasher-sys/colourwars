<!DOCTYPE html>
<html>
<head>
  <title>Colour Wars — Online Multiplayer</title>
  <style>
    body { display: flex; flex-direction: column; align-items: center; margin-top: 30px; font-family: sans-serif; }
    #lobby { text-align: center; }
    #lobby button, #lobby input { font-size: 16px; padding: 10px 16px; margin: 8px; }
    #gameArea { display: none; }
    canvas { border: 2px solid black; display: block; }
    #turnIndicator { margin-bottom: 10px; font-size: 18px; font-weight: bold; min-height: 1.5em; }
    #roomCode { margin-bottom: 8px; font-size: 14px; color: #282; }
    #roomCode span { font-weight: bold; letter-spacing: 2px; }
    #playerInfo { margin-bottom: 6px; font-size: 14px; }
    #timerBar { margin-bottom: 8px; display: flex; gap: 12px; align-items: center; }
    #timerBar .timer { font-size: 16px; font-weight: bold; }
  </style>
</head>
<body>
<div id="lobby">
  <h1>Colour Wars — Online</h1>
  <p>Find a random opponent or play with a friend using a room code.</p>
  <button id="findMatchBtn">Find Game</button>
  <div id="matchmakingStatus" style="display: none; margin-top: 10px;">
    <span id="matchmakingText">Searching for opponent...</span>
    <button id="cancelMatchBtn" style="margin-left: 12px;">Cancel</button>
  </div>
  <p style="margin-top: 16px; font-size: 14px; color: #282;">— or —</p>
  <button id="createBtn">Create Private Game</button>
  <div style="margin-top: 16px;">
    <input type="text" id="joinInput" placeholder="Room code" maxlength="6" style="text-transform: uppercase;">
    <button id="joinBtn">Join Game</button>
  </div>
  <p id="connectionStatus" style="margin-top: 12px; font-size: 14px; min-height: 1.2em;"></p>
  <p id="lobbyMsg" style="margin-top: 8px; color: #c00; min-height: 1.2em;"></p>
</div>

<div id="gameArea">
  <div id="roomCode">Room: <span id="roomCodeVal"></span></div>
  <div id="playerInfo">You control: <span id="myColour"></span></div>
  <div id="turnIndicator">Red's turn</div>
  <div id="timerBar">
    <span class="timer" id="redTimer" style="color: #c22;">5:00</span>
    <span class="timer" id="greenTimer" style="color: #282;">5:00</span>
  </div>
  <canvas id="boardCanvas" width="350" height="350"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
if (typeof io === "undefined") {
  document.getElementById("lobbyMsg").textContent = "Cannot connect. Open this page via http://localhost:3000 (start the server with: npm start)";
  document.getElementById("createBtn").disabled = true;
  document.getElementById("joinBtn").disabled = true;
  document.getElementById("findMatchBtn").disabled = true;
} else {
  const socket = io();
  const statusEl = document.getElementById("connectionStatus");
  statusEl.textContent = "Connecting...";
  socket.on("connect", () => {
    statusEl.textContent = "Connected";
    statusEl.style.color = "#282";
  });
  socket.on("connect_error", () => {
    statusEl.textContent = "Disconnected. Is the server running? (npm start)";
    statusEl.style.color = "#c00";
  });
  socket.on("disconnect", () => {
    statusEl.textContent = "Disconnected";
    statusEl.style.color = "#c00";
  });
const rows = 7;
const cols = 7;
const cellSize = 50;
const red = 1;
const green = -1;
const PLAYER_NAMES = { [red]: "Red", [green]: "Green" };
const PLAYER_COLORS = { [red]: "#c22", [green]: "#282" };

let board = null;
let myPlayer = null;
let roomCode = null;
let currentPlayer = red;
let winner = 0;
let gameEnded = false;
let redTimeRemaining = 300;
let greenTimeRemaining = 300;
let turnStartTime = 0;
let redIsAI = false;
let greenIsAI = false;
let playersReady = false;
let timerInterval = null;
const canvas = document.getElementById("boardCanvas");
const ctx = canvas.getContext("2d");

function showLobby(msg) {
  document.getElementById("lobby").style.display = "block";
  document.getElementById("gameArea").style.display = "none";
  document.getElementById("lobbyMsg").textContent = msg || "";
  document.getElementById("joinBtn").disabled = false;
  document.getElementById("findMatchBtn").disabled = false;
  document.getElementById("matchmakingStatus").style.display = "none";
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
}

function showGame(showRoomCode) {
  document.getElementById("lobby").style.display = "none";
  document.getElementById("gameArea").style.display = "block";
  document.getElementById("matchmakingStatus").style.display = "none";
  document.getElementById("roomCodeVal").textContent = roomCode + (showRoomCode ? " (2 players)" : "");
}

function isUnstable(board, row, col) {
  return board[row][col].count >= 4;
}

function drawBoard() {
  if (!board) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      ctx.strokeStyle = "black";
      ctx.strokeRect(c * cellSize, r * cellSize, cellSize, cellSize);
      const cell = board[r][c];
      if (cell.count > 0) {
        ctx.fillStyle = cell.owner === red ? "#c22" : "#282";
        const radius = 10 + 5 * (cell.count - 1);
        ctx.beginPath();
        ctx.arc(c * cellSize + cellSize / 2, r * cellSize + cellSize / 2, radius, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = "white";
        ctx.font = "bold 16px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(cell.count, c * cellSize + cellSize / 2, r * cellSize + cellSize / 2);
      }
      if (isUnstable(board, r, c)) {
        ctx.strokeStyle = "orange";
        ctx.lineWidth = 3;
        ctx.strokeRect(c * cellSize + 1, r * cellSize + 1, cellSize - 2, cellSize - 2);
        ctx.lineWidth = 1;
      }
    }
  }
}

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return m + ":" + (s < 10 ? "0" : "") + s;
}

function updateTurnIndicator() {
  const turnEl = document.getElementById("turnIndicator");
  const myColEl = document.getElementById("myColour");
  if (myColEl) {
    myColEl.textContent = PLAYER_NAMES[myPlayer];
    myColEl.style.color = PLAYER_COLORS[myPlayer];
  }
  if (winner !== 0) {
    turnEl.textContent = PLAYER_NAMES[winner] + " wins!";
    turnEl.style.color = PLAYER_COLORS[winner];
    return;
  }
  if (!playersReady) {
    turnEl.textContent = "Waiting for opponent to join...";
    turnEl.style.color = "";
    return;
  }
  const isMyTurn = currentPlayer === myPlayer;
  const cpName = PLAYER_NAMES[currentPlayer];
  const cpIsAI = (currentPlayer === red && redIsAI) || (currentPlayer === green && greenIsAI);
  if (isMyTurn) {
    turnEl.textContent = "Your turn (" + cpName + ")";
  } else {
    turnEl.textContent = (cpIsAI ? "AI" : "Opponent") + "'s turn (" + cpName + ")";
  }
  turnEl.style.color = PLAYER_COLORS[currentPlayer] || "";
}

function updateTimerDisplay() {
  if (!board || gameEnded) return;
  let redDisplay = redTimeRemaining;
  let greenDisplay = greenTimeRemaining;
  if (playersReady) {
    const now = Date.now() / 1000;
    const elapsed = now - (turnStartTime / 1000);
    if (currentPlayer === red && !redIsAI) redDisplay = Math.max(0, redTimeRemaining - elapsed);
    else if (currentPlayer === green && !greenIsAI) greenDisplay = Math.max(0, greenTimeRemaining - elapsed);
  }
  document.getElementById("redTimer").textContent = "Red: " + formatTime(redDisplay);
  document.getElementById("greenTimer").textContent = "Green: " + formatTime(greenDisplay);
}

canvas.addEventListener("click", (e) => {
  if (!board || gameEnded || winner !== 0) return;
  if (currentPlayer !== myPlayer) return;
  if ((currentPlayer === red && redIsAI) || (currentPlayer === green && greenIsAI)) return;

  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const x = (e.clientX - rect.left) * scaleX;
  const y = (e.clientY - rect.top) * scaleY;
  const row = Math.floor(y / cellSize);
  const col = Math.floor(x / cellSize);

  socket.emit("move", { code: roomCode, row, col });
});

socket.on("roomCreated", (data) => {
  roomCode = data.code;
  myPlayer = data.player;
  showGame(false);
});

socket.on("joinedRoom", (data) => {
  roomCode = data.code;
  myPlayer = data.player;
  showGame(true);
});

socket.on("matched", (data) => {
  roomCode = data.code;
  myPlayer = data.player;
  showGame(false);
});

socket.on("matchmakingStatus", (data) => {
  if (data.searching) {
    document.getElementById("findMatchBtn").disabled = true;
    document.getElementById("matchmakingStatus").style.display = "block";
    document.getElementById("matchmakingText").textContent = "Searching for opponent... (queue: " + (data.position || "?") + ")";
    document.getElementById("lobbyMsg").textContent = "";
  } else {
    document.getElementById("findMatchBtn").disabled = false;
    document.getElementById("matchmakingStatus").style.display = "none";
    document.getElementById("lobbyMsg").textContent = "";
  }
});

socket.on("joinError", (msg) => {
  document.getElementById("joinBtn").disabled = false;
  document.getElementById("lobbyMsg").textContent = msg;
});

socket.on("gameState", (state) => {
  board = state.board;
  currentPlayer = state.currentPlayer;
  winner = state.winner || 0;
  gameEnded = winner !== 0;
  redTimeRemaining = state.redTimeRemaining ?? 300;
  greenTimeRemaining = state.greenTimeRemaining ?? 300;
  turnStartTime = state.turnStartTime ?? Date.now();
  redIsAI = state.redIsAI || false;
  greenIsAI = state.greenIsAI || false;
  playersReady = state.playersReady || false;
  drawBoard();
  updateTurnIndicator();
  updateTimerDisplay();
  if (!timerInterval && !gameEnded) {
    timerInterval = setInterval(updateTimerDisplay, 200);
  }
  if (gameEnded) {
    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
    setTimeout(() => alert(PLAYER_NAMES[winner] + " wins!"), 100);
  }
});

socket.on("playerTimedOut", (data) => {
  const p = data.player;
  if (p === red) redIsAI = true;
  else greenIsAI = true;
  if (p === myPlayer) {
    alert("You ran out of time! AI is now playing for you.");
  } else {
    alert("Opponent ran out of time. AI has taken over.");
  }
});

socket.on("playerJoined", () => {
  const el = document.getElementById("roomCodeVal");
  if (el) el.textContent = roomCode + " (2 players)";
});

socket.on("opponentLeft", () => {
  alert("Opponent left the game.");
  roomCode = null;
  board = null;
  showLobby("Opponent disconnected. Create or join a new game.");
});

document.getElementById("findMatchBtn").addEventListener("click", () => {
  document.getElementById("lobbyMsg").textContent = "";
  socket.emit("findMatch");
});

document.getElementById("cancelMatchBtn").addEventListener("click", () => {
  socket.emit("cancelMatchmaking");
});

document.getElementById("createBtn").addEventListener("click", () => {
  socket.emit("createRoom");
});

document.getElementById("joinBtn").addEventListener("click", () => {
  const code = document.getElementById("joinInput").value.trim();
  if (!code) {
    document.getElementById("lobbyMsg").textContent = "Enter a room code";
    return;
  }
  document.getElementById("joinBtn").disabled = true;
  document.getElementById("lobbyMsg").textContent = "Joining...";
  socket.emit("joinRoom", code);
});

document.getElementById("joinInput").addEventListener("keypress", (e) => {
  if (e.key === "Enter") document.getElementById("joinBtn").click();
});
}
</script>
</body>
</html>
